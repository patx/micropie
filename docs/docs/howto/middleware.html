<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Writing middleware &#8212; MicroPie 0.20 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css?v=f6a572b4" />
    <script src="../_static/documentation_options.js?v=0144e382"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Rendering templates" href="templates.html" />
    <link rel="prev" title="Managing sessions" href="sessions.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">MicroPie</a></h1>



<p class="blurb">A minimal ASGI web framework</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=patx&repo=micropie&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>






<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../tutorial/index.html">Tutorials</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">How‑to guides</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="sessions.html">Managing sessions</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Writing middleware</a></li>
<li class="toctree-l2"><a class="reference internal" href="templates.html">Rendering templates</a></li>
<li class="toctree-l2"><a class="reference internal" href="streaming.html">Streaming responses</a></li>
<li class="toctree-l2"><a class="reference internal" href="static_files.html">Serving static files</a></li>
<li class="toctree-l2"><a class="reference internal" href="socketio.html">Integrating Socket.IO</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference/index.html">API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanation/index.html">Explanations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">How‑to guides</a><ul>
      <li>Previous: <a href="sessions.html" title="previous chapter">Managing sessions</a></li>
      <li>Next: <a href="templates.html" title="next chapter">Rendering templates</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="writing-middleware">
<h1>Writing middleware<a class="headerlink" href="#writing-middleware" title="Link to this heading">¶</a></h1>
<p>Middleware allows you to insert code that runs before and after your
handlers.  It is useful for cross‑cutting concerns such as logging,
authentication, rate limiting or explicit routing.  MicroPie defines
separate middleware classes for HTTP and WebSocket connections.</p>
<section id="http-middleware">
<h2>HTTP middleware<a class="headerlink" href="#http-middleware" title="Link to this heading">¶</a></h2>
<p>To create HTTP middleware, subclass <code class="xref py py-class docutils literal notranslate"><span class="pre">HttpMiddleware</span></code>
and implement two asynchronous methods:</p>
<ul class="simple">
<li><p><code class="xref py py-meth docutils literal notranslate"><span class="pre">before_request()</span></code> – called before the
handler is executed.  If this method returns a dictionary with
<code class="docutils literal notranslate"><span class="pre">status_code</span></code> and <code class="docutils literal notranslate"><span class="pre">body</span></code> keys, MicroPie immediately sends that
response and skips calling the handler.  You can also provide
additional headers via a <code class="docutils literal notranslate"><span class="pre">headers</span></code> key.</p></li>
<li><p><code class="xref py py-meth docutils literal notranslate"><span class="pre">after_request()</span></code> – called after the
handler has returned a response but before it is sent to the client.
You can modify the status code, body or headers by returning a
dictionary with updated values.</p></li>
</ul>
<p>Register your middleware by appending an instance to
<code class="xref py py-attr docutils literal notranslate"><span class="pre">middlewares</span></code> on your application:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">micropie</span> <span class="kn">import</span> <span class="n">App</span><span class="p">,</span> <span class="n">HttpMiddleware</span>

<span class="k">class</span> <span class="nc">LoggingMiddleware</span><span class="p">(</span><span class="n">HttpMiddleware</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">before_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Incoming request: </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">scope</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># returning None continues processing</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">after_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">headers</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Response status: </span><span class="si">{</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># returning None uses the original response</span>

<span class="k">class</span> <span class="nc">MyApp</span><span class="p">(</span><span class="n">App</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Hello, world!&quot;</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">MyApp</span><span class="p">()</span>
<span class="n">app</span><span class="o">.</span><span class="n">middlewares</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">LoggingMiddleware</span><span class="p">())</span>
</pre></div>
</div>
</section>
<section id="websocket-middleware">
<h2>WebSocket middleware<a class="headerlink" href="#websocket-middleware" title="Link to this heading">¶</a></h2>
<p>WebSocket middleware must subclass <code class="xref py py-class docutils literal notranslate"><span class="pre">WebSocketMiddleware</span></code>
and implement two methods:</p>
<ul class="simple">
<li><p><code class="xref py py-meth docutils literal notranslate"><span class="pre">before_websocket()</span></code> – called
before a WebSocket handler runs.  If this method returns a
dictionary with <code class="docutils literal notranslate"><span class="pre">code</span></code> and <code class="docutils literal notranslate"><span class="pre">reason</span></code>, MicroPie closes the
connection with the given code and reason.</p></li>
<li><p><code class="xref py py-meth docutils literal notranslate"><span class="pre">after_websocket()</span></code> – called after
the WebSocket handler completes.  Use this to perform cleanup.</p></li>
</ul>
<p>Example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">micropie</span> <span class="kn">import</span> <span class="n">App</span><span class="p">,</span> <span class="n">WebSocketMiddleware</span>

<span class="k">class</span> <span class="nc">RejectAnonymous</span><span class="p">(</span><span class="n">WebSocketMiddleware</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">before_websocket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="c1"># Reject connections without a &quot;user&quot; query parameter</span>
        <span class="k">if</span> <span class="s2">&quot;user&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">1008</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;User name required&quot;</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">after_websocket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WebSocket closed&quot;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">MyApp</span><span class="p">(</span><span class="n">App</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">ws_chat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ws</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="k">await</span> <span class="n">ws</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
        <span class="k">await</span> <span class="n">ws</span><span class="o">.</span><span class="n">send_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Welcome, </span><span class="si">{</span><span class="n">user</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">ws</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">MyApp</span><span class="p">()</span>
<span class="n">app</span><span class="o">.</span><span class="n">ws_middlewares</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RejectAnonymous</span><span class="p">())</span>
</pre></div>
</div>
</section>
<section id="explicit-routing-and-other-patterns">
<h2>Explicit routing and other patterns<a class="headerlink" href="#explicit-routing-and-other-patterns" title="Link to this heading">¶</a></h2>
<p>You can implement custom routing schemes by writing middleware that
parses the incoming path and sets <code class="docutils literal notranslate"><span class="pre">request._route_handler</span></code> or
<code class="docutils literal notranslate"><span class="pre">request._ws_route_handler</span></code> accordingly.  See the examples in the
<code class="docutils literal notranslate"><span class="pre">examples/middleware</span></code> directory for a complete implementation.</p>
</section>
</section>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &#169;.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="../_sources/howto/middleware.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>